<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#6f4e37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¿¡ç¾©åº—è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        coffee: { 50:'#fdf8f6', 100:'#f2e8e5', 200:'#eaddd7', 500:'#a67c52', 600:'#8b5a3b', 700:'#6f4e37', 800:'#4a3b32', 900:'#3e312b' },
                        beige: { 100:'#f5f5dc', 200:'#efebd4' }
                    },
                    boxShadow: { 'top': '0 -4px 6px -1px rgba(0, 0, 0, 0.1)' },
                    zIndex: { '60': '60', '70': '70' }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { color: #6f4e37; font-weight: bold; }
        .tab-inactive { color: #9ca3af; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eaddd7; border-top: 4px solid #6f4e37; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-cell { min-height: 100px; background: white; border: 1px solid #e7e5e4; padding: 4px; display: flex; flex-direction: column; gap: 2px; position: relative; cursor: pointer; transition: background 0.2s; border-radius: 4px; }
        .calendar-cell:active { background-color: #f5f5f4; border-color: #d6d3d1; }
        
        .shift-row { font-size: 11px; display: flex; align-items: center; gap: 4px; margin-bottom: 3px; overflow: hidden; white-space: nowrap; background: #fafaf9; border-radius: 6px; padding: 2px 4px; border: 1px solid #f5f5f4; }
        .shift-label { font-weight: bold; color: #78716c; font-size: 11px; flex-shrink: 0; }
        .emp-name { font-weight: 700; font-size: 11px; text-shadow: 0 0 1px rgba(0,0,0,0.05); }
        
        .day-number { font-size: 12px; font-weight: bold; color: #78716c; margin-bottom: 4px; text-align: center; }
        .holiday-tag { font-size: 9px; background: #fee2e2; color: #ef4444; border-radius: 4px; padding: 0 3px; margin-left: 2px; display: inline-block; font-weight: normal; }
        .chk-btn:checked + label { background-color: #6f4e37; color: white; border-color: #6f4e37; }
        .notice-card { border-left: 4px solid #a67c52; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 8px; position: relative; }
        .notice-card.high { border-left-color: #ef4444; }
        .notice-card.normal { border-left-color: #3b82f6; }
        .notice-delete { position: absolute; top: 8px; right: 8px; color: #d6d3d1; padding: 4px; }
        .notice-delete:hover { color: #ef4444; }
    </style>
</head>
<body class="bg-[#f8f6f4] text-coffee-900 h-screen overflow-hidden flex flex-col">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-coffee-800 font-bold text-sm tracking-wide">ç³»çµ±é€£ç·šä¸­...</div>
    </div>

    <header class="bg-coffee-700 text-white pt-safe-top pb-3 px-4 shadow-md z-20 shrink-0">
        <div class="flex justify-between items-center pt-2">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-4.5-6c-2 0-4 2-5 4"/></svg>
                ä¿¡ç¾©åº—è¨˜å¸³
            </h1>
            <input type="month" id="month-select" class="bg-coffee-800 border border-coffee-600 text-white text-sm rounded px-2 py-1 outline-none focus:ring-1 focus:ring-orange-300">
        </div>
    </header>

    <main class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 hide-scrollbar relative">
        
        <!-- 1. Home Tab -->
        <div id="view-home" class="fade-in space-y-4">
            
            <!-- å…¬å‘Šå€ -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-coffee-800 text-sm flex items-center gap-1"><span class="text-lg">ğŸ“¢</span> åº—é‹ªå…¬å‘Š</h3>
                    <button onclick="addNotice()" class="text-xs bg-coffee-100 text-coffee-700 px-2 py-1 rounded font-bold hover:bg-coffee-200">+ ç™¼å¸ƒ</button>
                </div>
                <div id="notice-list" class="space-y-2"></div>
                <div id="notice-empty" class="text-xs text-stone-400 text-center py-2">å°šç„¡å…¬å‘Š</div>
            </div>

            <!-- Dashboard -->
            <div class="flex gap-3 overflow-x-auto pb-2 hide-scrollbar snap-x">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 min-w-[140px] snap-center flex-1">
                    <div class="text-xs text-gray-500 mb-1">æœ¬æœˆæ”¶å…¥</div>
                    <div class="text-xl font-bold text-coffee-800 font-mono" id="disp-income">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400 min-w-[140px] snap-center flex-1">
                    <div class="text-xs text-gray-500 mb-1">æœ¬æœˆæ”¯å‡º</div>
                    <div class="text-xl font-bold text-coffee-800 font-mono" id="disp-expense">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-coffee-500 min-w-[140px] snap-center flex-1">
                    <div class="text-xs text-gray-500 mb-1">æœ¬æœˆæ·¨åˆ©</div>
                    <div class="text-xl font-bold text-coffee-700 font-mono" id="disp-net">0</div>
                </div>
            </div>

            <!-- Transaction Form -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                <div class="flex bg-stone-100 p-1 rounded-xl mb-4">
                    <button onclick="setType('out')" id="btn-out" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-red-400 text-white shadow-sm">æ”¯å‡º</button>
                    <button onclick="setType('in')" id="btn-in" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-gray-400">æ”¶å…¥</button>
                </div>
                <div class="space-y-4">
                    <div id="expense-options">
                        <label class="text-xs font-bold text-stone-400 ml-1 uppercase">é …ç›® Category</label>
                        <div class="flex gap-2 mt-1">
                            <select id="cat-select" onchange="updateItemSelect()" class="w-1/3 bg-stone-50 border border-stone-200 rounded-xl p-3 text-coffee-900 outline-none focus:border-coffee-500 transition-colors">
                                <option value="stock">å«è²¨</option>
                                <option value="rent">æˆ¿ç§Ÿ</option>
                                <option value="mgmt">ç®¡ç†è²»</option>
                                <option value="electric">é›»è²»</option>
                                <option value="water">æ°´è²»</option>
                                <option value="labor">äººäº‹</option>
                                <option value="insurance">ä¿éšª</option>
                                <option value="other">é›œæ”¯</option>
                            </select>
                            <div class="w-2/3 relative">
                                <select id="item-select" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-coffee-900 outline-none focus:border-coffee-500 appearance-none"></select>
                                <input type="text" id="custom-note" placeholder="è¼¸å…¥å‚™è¨»..." class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-coffee-900 outline-none focus:border-coffee-500 hidden">
                                <div id="select-arrow" class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-stone-400"><svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></div>
                            </div>
                        </div>
                        <div id="stock-details" class="hidden grid grid-cols-2 gap-3 mt-3 bg-orange-50 p-3 rounded-xl border border-orange-100">
                            <div><label class="text-[10px] font-bold text-coffee-500 uppercase">æ•¸é‡ Qty</label><input type="number" inputmode="decimal" id="qty-input" class="w-full mt-1 border border-orange-200 rounded-lg p-2 text-coffee-900 bg-white focus:ring-2 focus:ring-orange-200 outline-none text-center font-bold"></div>
                            <div>
                                <label class="text-[10px] font-bold text-coffee-500 uppercase">å–®ä½ Unit</label>
                                <select id="unit-input" class="w-full mt-1 border border-orange-200 rounded-lg p-2 text-coffee-900 bg-white outline-none">
                                    <option value="åŒ…">åŒ…</option><option value="ç½">ç½</option><option value="æ–¤">æ–¤</option><option value="ä»¶">ä»¶</option><option value="ç®±">ç®±</option><option value="è¢‹">è¢‹</option><option value="ç“¶">ç“¶</option><option value="å€‹">å€‹</option><option value="æ¡¶">æ¡¶</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="income-options" class="hidden"><label class="text-xs font-bold text-stone-400 ml-1 uppercase">å‚™è¨» Note</label><input type="text" id="income-note" placeholder="ä¾‹ï¼šä»Šæ—¥ç‡Ÿæ”¶" class="w-full mt-1 bg-stone-50 border border-stone-200 rounded-xl p-3 text-coffee-900 outline-none focus:border-coffee-500"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1 uppercase">é‡‘é¡ Amount</label><input type="number" inputmode="decimal" id="amount-input" placeholder="0" class="w-full mt-1 bg-stone-50 border border-stone-200 rounded-xl p-3 text-xl font-bold font-mono text-coffee-900 outline-none focus:border-coffee-500 focus:ring-2 focus:ring-coffee-100 transition-all"></div>
                    <button id="btn-save" class="w-full bg-coffee-600 active:bg-coffee-800 text-white py-3.5 rounded-xl font-bold shadow-md hover:shadow-lg transition-all transform active:scale-[0.98] flex justify-center items-center gap-2 mt-2">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
            
            <!-- GPS Simulation Button (For Testing) -->
            <button onclick="simulateCheckIn()" class="w-full bg-white border-2 border-dashed border-coffee-300 text-coffee-600 py-3 rounded-xl font-bold text-sm hover:bg-coffee-50 transition-colors flex items-center justify-center gap-2">
                <span class="text-lg">ğŸ“±</span> æ¨¡æ“¬æ‰“å¡å›å‚³è³‡æ–™ (æ¸¬è©¦ç”¨)
            </button>
            <p class="text-[10px] text-center text-stone-400">ç•¶å“¡å·¥åœ¨å°ˆå±¬ App æ‰“å¡æ™‚ï¼Œè³‡æ–™æœƒå³æ™‚åŒæ­¥è‡³æ­¤</p>

            <div class="grid grid-cols-2 gap-3">
                <button id="btn-fixed-cost" class="bg-white border border-stone-200 p-3 rounded-xl text-xs font-medium text-stone-600 shadow-sm active:bg-stone-50 flex flex-col items-center gap-1"><span class="text-red-400 text-lg">ğŸ </span>+ æˆ¿ç§Ÿèˆ‡ç®¡ç†è²»</button>
                <button id="btn-fixed-income" class="bg-white border border-stone-200 p-3 rounded-xl text-xs font-medium text-stone-600 shadow-sm active:bg-stone-50 flex flex-col items-center gap-1"><span class="text-green-500 text-lg">ğŸ’°</span>+ é ä¼°å›ºå®šç‡Ÿæ”¶</button>
            </div>
        </div>

        <!-- 2. Report Tab -->
        <div id="view-report" class="hidden fade-in space-y-4">
            <div class="flex bg-stone-200 p-1 rounded-xl">
                <button onclick="changeReportPeriod('month')" id="rp-month" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-white text-coffee-700 shadow-sm transition-all">æœˆ</button>
                <button onclick="changeReportPeriod('quarter')" id="rp-quarter" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-stone-500 transition-all">å­£</button>
                <button onclick="changeReportPeriod('half')" id="rp-half" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-stone-500 transition-all">åŠå¹´</button>
                <button onclick="changeReportPeriod('year')" id="rp-year" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-stone-500 transition-all">å¹´</button>
            </div>
            <div class="text-center text-xs text-stone-400 font-bold" id="report-date-range"></div>
            <div class="flex border-b border-stone-200">
                <button onclick="switchReportTab('chart')" id="subtab-chart" class="flex-1 py-2 text-sm font-bold text-coffee-700 border-b-2 border-coffee-600 transition-all">æ”¶æ”¯è¶¨å‹¢</button>
                <button onclick="switchReportTab('stock')" id="subtab-stock" class="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent transition-all">å«è²¨åˆ†æ</button>
                <button onclick="switchReportTab('attn')" id="subtab-attn" class="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent transition-all">å‡ºå‹¤ç‡</button>
            </div>
            
            <!-- Chart & Stock View -->
            <div id="report-chart" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-stone-100"><div class="text-xs text-stone-400 mb-1">ç‡Ÿæ”¶æ¯”è¼ƒ</div><div class="text-lg font-bold text-coffee-800 font-mono" id="comp-inc-curr">0</div><div class="text-[10px] flex items-center gap-1 mt-1" id="comp-inc-diff"><span class="text-stone-400">vs ä¸ŠæœŸ $0</span></div></div>
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-stone-100"><div class="text-xs text-stone-400 mb-1">æ·¨åˆ©æ¯”è¼ƒ</div><div class="text-lg font-bold text-coffee-800 font-mono" id="comp-net-curr">0</div><div class="text-[10px] flex items-center gap-1 mt-1" id="comp-net-diff"><span class="text-stone-400">vs ä¸ŠæœŸ $0</span></div></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                    <div class="flex flex-col items-center mb-2"><h4 class="font-bold text-coffee-700 mb-4 text-sm">æˆæœ¬çµæ§‹ä½”æ¯”</h4><div class="relative w-48 h-48"><svg id="pie-chart" viewBox="0 0 100 100" class="w-full h-full transform -rotate-90"></svg></div><div id="pie-legend" class="grid grid-cols-2 gap-x-4 gap-y-2 mt-6 text-xs text-stone-600 w-full"></div></div>
                </div>
            </div>
            <div id="report-stock" class="hidden space-y-3">
                <div class="flex justify-between text-xs text-stone-400 px-2 font-bold uppercase"><span>å“é …</span><span>æœ¬æœŸæ•¸é‡ (vsä¸ŠæœŸ)</span></div>
                <div id="stock-list" class="space-y-3"></div><div id="stock-empty-msg" class="text-center text-stone-400 py-10 bg-white rounded-2xl border border-stone-100">å°šç„¡è³‡æ–™</div>
            </div>
            
            <!-- Attendance Rate View -->
            <div id="report-attn" class="hidden space-y-3">
                 <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                     <h4 class="font-bold text-coffee-800 mb-3 text-sm">æœ¬æœˆå‡ºå‹¤çµ±è¨ˆ (Schedules vs Logs)</h4>
                     <div id="attn-stats-list" class="space-y-3"></div>
                     <div id="attn-stats-empty" class="text-center text-stone-400 text-xs py-4">ç„¡æ’ç­æˆ–æ‰“å¡ç´€éŒ„</div>
                 </div>
            </div>
        </div>

        <!-- 3. Schedule Tab (Optimized) -->
        <div id="view-schedule" class="hidden fade-in space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-coffee-800">æœ¬æœˆç­è¡¨</h3>
                    <div class="flex gap-2">
                        <button onclick="addLeave()" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg font-bold active:bg-red-200">ç™»è¨˜è«‹å‡</button>
                        <button onclick="autoSchedule()" class="text-xs bg-coffee-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm active:bg-coffee-800">ä¸€éµæ’ç­</button>
                        <button onclick="clearSchedule()" class="text-xs bg-white text-red-500 border border-red-200 px-3 py-1.5 rounded-lg font-bold active:bg-red-50">æ¸…ç©º</button>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-2 text-[10px] text-stone-500 justify-center">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-100 border border-blue-200 rounded-full"></span>æ—© 8-12</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-yellow-100 border border-yellow-200 rounded-full"></span>ç™½ 11:30-15:30</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-purple-100 border border-purple-200 rounded-full"></span>æ™š 16:30-20:30</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-stone-200 border border-stone-300 rounded-full"></span>å‡</span>
                </div>

                <div class="text-center text-[10px] text-stone-400 mb-2">ğŸ’¡ é»æ“Šæ—¥æœŸå¯æ‰‹å‹•èª¿æ•´ç­åˆ¥</div>

                <div class="calendar-grid text-center font-bold text-stone-400 mb-2 text-xs">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div id="schedule-calendar" class="calendar-grid bg-stone-100 rounded-lg overflow-hidden border border-stone-200"></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                <h4 class="font-bold text-sm text-coffee-700 mb-3">è«‹å‡ç´€éŒ„</h4>
                <div id="leave-list" class="space-y-2"></div>
                <div id="leave-empty" class="text-xs text-center text-stone-400 py-4">ç„¡è«‹å‡ç´€éŒ„</div>
            </div>
        </div>

        <!-- 4. Staff Tab -->
        <div id="view-staff" class="hidden fade-in space-y-4">
            <div class="flex justify-end">
                <button onclick="addEmployee()" class="bg-coffee-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md flex items-center gap-1">+ æ–°å¢å“¡å·¥</button>
            </div>
            <div class="bg-orange-50 border border-orange-100 p-3 rounded-xl text-xs text-coffee-700 mb-2">
                <span class="font-bold">ğŸ¯ çé‡‘èˆ‡è¦å‰‡ï¼š</span>
                <div class="grid grid-cols-1 gap-1 mt-1 opacity-80">
                    <span>â€¢ è·å‹™ï¼šæœ¨ç™½åŒ (å…¨æ™‚æ®µ)ã€ç³–äº‹äºº(åƒ…ç™½/æ™šç­)</span>
                    <span>â€¢ è¦å‰‡ï¼šåšå…­ä¼‘ä¸€ã€åœ‹å®šå‡æ—¥é›™è–ª</span>
                    <span>â€¢ æ»¿40hr+$500 / 80hr+$1000 / 120hr+$1500...</span>
                </div>
            </div>
            <div id="staff-list" class="space-y-3"></div>
            <div id="staff-empty" class="text-center text-stone-400 py-10 bg-white rounded-2xl border border-stone-100">å°šç„¡å“¡å·¥è³‡æ–™ï¼Œè«‹æ–°å¢</div>
        </div>

        <!-- 5. List Tab -->
        <div id="view-list" class="hidden fade-in bg-white rounded-2xl shadow-sm border border-stone-100 overflow-hidden min-h-[50vh] pb-24">
            <div class="flex border-b border-stone-200">
                <button onclick="switchListTab('tx')" id="ltab-tx" class="flex-1 py-3 text-sm font-bold text-coffee-700 border-b-2 border-coffee-600">æ”¶æ”¯æ˜ç´°</button>
                <button onclick="switchListTab('attn')" id="ltab-attn" class="flex-1 py-3 text-sm font-bold text-stone-400 border-b-2 border-transparent">å‡ºå‹¤ç´€éŒ„</button>
            </div>
            <div id="list-tx-container">
                <div class="p-3 bg-stone-50 border-b border-stone-100 text-xs font-bold text-stone-500 uppercase tracking-wider flex justify-between"><span>æ—¥æœŸ / é …ç›®</span><span>é‡‘é¡</span></div>
                <div id="transaction-list" class="divide-y divide-stone-100"></div>
                <div id="empty-msg" class="text-center text-stone-400 py-10">æœ¬æœˆå°šç„¡è³‡æ–™</div>
            </div>
            <div id="list-attn-container" class="hidden">
                <div class="p-3 bg-stone-50 border-b border-stone-100 text-xs font-bold text-stone-500 uppercase tracking-wider">æ‰“å¡ç´€éŒ„ (Logs)</div>
                <div id="attendance-list" class="divide-y divide-stone-100"></div>
                <div id="attn-empty-msg" class="text-center text-stone-400 py-10">å°šç„¡æ‰“å¡ç´€éŒ„</div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bg-white border-t border-stone-200 flex justify-around items-center pb-safe-bottom pt-2 h-[calc(60px+env(safe-area-inset-bottom))] shadow-top fixed bottom-0 w-full z-30">
        <button onclick="switchMainTab('home')" id="nav-home" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-coffee-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="text-[9px] font-bold">è¨˜å¸³</span></button>
        <button onclick="switchMainTab('report')" id="nav-report" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-stone-400"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="text-[9px] font-bold">å ±è¡¨</span></button>
        <button onclick="switchMainTab('schedule')" id="nav-schedule" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-stone-400"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="text-[9px] font-bold">æ’ç­</span></button>
        <button onclick="switchMainTab('staff')" id="nav-staff" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-stone-400"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="text-[9px] font-bold">å“¡å·¥</span></button>
        <button onclick="switchMainTab('list')" id="nav-list" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-stone-400"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg><span class="text-[9px] font-bold">æ˜ç´°</span></button>
    </nav>

    <!-- Modal (General - Highest Z-Index) -->
    <div id="app-modal" class="fixed inset-0 bg-stone-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
        <div class="bg-[#fcfbf9] rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden border border-stone-100 transform transition-all scale-100">
            <div class="p-6">
                <h3 id="modal-title" class="text-lg font-bold text-coffee-800 mb-2">æç¤º</h3>
                <p id="modal-msg" class="text-stone-600 mb-4 text-sm leading-relaxed whitespace-pre-line"></p>
                <div id="modal-input-container" class="hidden mb-1"><input type="number" inputmode="decimal" id="modal-input" class="w-full border border-stone-300 rounded-xl p-3 bg-white text-coffee-900 text-lg outline-none focus:ring-2 focus:ring-coffee-500"></div>
                <div id="modal-notice-inputs" class="hidden space-y-2 mb-1">
                    <input type="text" id="notice-title" placeholder="æ¨™é¡Œ" class="w-full border p-2 rounded">
                    <textarea id="notice-content" placeholder="å…§å®¹" class="w-full border p-2 rounded"></textarea>
                    <select id="notice-priority" class="w-full border p-2 rounded"><option value="normal">ä¸€èˆ¬</option><option value="high">ç·Šæ€¥</option></select>
                </div>
            </div>
            <div class="bg-stone-50 px-6 py-4 flex gap-3 border-t border-stone-200">
                <button id="modal-btn-cancel" class="flex-1 py-3 text-stone-600 bg-white border border-stone-200 rounded-xl text-sm font-bold shadow-sm active:bg-stone-100">å–æ¶ˆ</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 bg-coffee-600 text-white rounded-xl shadow-md text-sm font-bold active:bg-coffee-800">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Staff Edit Modal -->
    <div id="staff-modal" class="fixed inset-0 bg-stone-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b border-stone-100 flex justify-between items-center">
                <h3 class="font-bold text-coffee-800 text-lg">å“¡å·¥è³‡æ–™</h3>
                <button onclick="document.getElementById('staff-modal').classList.add('hidden')" class="text-stone-400 p-2">âœ•</button>
            </div>
            <div class="p-5 space-y-4">
                <div><label class="text-xs text-stone-500 font-bold uppercase">å§“å</label><input id="st-name" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                <div>
                    <label class="text-xs text-stone-500 font-bold uppercase">Google Email (æ‰“å¡ç¶å®š)</label>
                    <input id="st-email" type="email" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50" placeholder="example@gmail.com">
                </div>
                <div>
                    <label class="text-xs text-stone-500 font-bold uppercase">è·ç¨± Role</label>
                    <select id="st-role" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50 outline-none">
                        <option value="æœ¨ç™½åŒ ">æœ¨ç™½åŒ  (å…¨ç­åˆ¥)</option>
                        <option value="ç³–äº‹äºº">ç³–äº‹äºº (åƒ…ç™½/æ™šç­)</option>
                    </select>
                </div>
                <div><label class="text-xs text-stone-500 font-bold uppercase">ä»£è¡¨è‰²</label><input type="color" id="st-color" class="w-full h-10 border border-stone-200 rounded-lg mt-1 p-1 bg-white cursor-pointer" value="#a67c52"></div>
                <div><label class="text-xs text-stone-500 font-bold uppercase">é›»è©±</label><input id="st-phone" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                <div><label class="text-xs text-stone-500 font-bold uppercase">åœ°å€</label><input id="st-addr" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                <div><label class="text-xs text-stone-500 font-bold uppercase">ç·Šæ€¥è¯çµ¡äºº</label><input id="st-emer" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50" placeholder="é—œä¿‚/é›»è©±"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-stone-500 font-bold uppercase">åˆ°è·æ—¥</label><input type="date" id="st-date" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                    <div><label class="text-xs text-stone-500 font-bold uppercase">æ™‚è–ª</label><input type="number" id="st-wage" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50" value="183"></div>
                </div>
            </div>
            <div class="p-5 bg-stone-50 border-t border-stone-100">
                <button onclick="saveEmployee()" class="w-full bg-coffee-600 text-white py-3 rounded-xl font-bold shadow-md">å„²å­˜å“¡å·¥è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leave-modal" class="fixed inset-0 bg-stone-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-stone-100"><h3 class="font-bold text-coffee-800 text-lg">ç™»è¨˜è«‹å‡</h3></div>
            <div class="p-5 space-y-4 overflow-y-auto">
                <div><label class="text-xs text-stone-500 font-bold uppercase">å“¡å·¥</label><select id="lv-emp" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></select></div>
                <div>
                    <label class="text-xs text-stone-500 font-bold uppercase mb-1 block">è«‹å‡æ¨¡å¼</label>
                    <div class="flex bg-stone-100 p-1 rounded-lg">
                        <button onclick="switchLeaveMode('single')" id="lm-single" class="flex-1 py-1.5 rounded text-xs font-bold bg-white shadow-sm">å–®æ—¥</button>
                        <button onclick="switchLeaveMode('range')" id="lm-range" class="flex-1 py-1.5 rounded text-xs font-bold text-stone-400">é€£çºŒ</button>
                        <button onclick="switchLeaveMode('recurring')" id="lm-recurring" class="flex-1 py-1.5 rounded text-xs font-bold text-stone-400">é€±æœŸ</button>
                    </div>
                </div>
                <div id="lv-date-single">
                    <label class="text-xs text-stone-500 font-bold uppercase">æ—¥æœŸ</label>
                    <input type="date" id="lv-date" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50">
                </div>
                <div id="lv-date-range" class="hidden grid grid-cols-2 gap-2">
                    <div><label class="text-xs text-stone-500 font-bold uppercase">é–‹å§‹</label><input type="date" id="lv-start" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                    <div><label class="text-xs text-stone-500 font-bold uppercase">çµæŸ</label><input type="date" id="lv-end" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"></div>
                </div>
                <div id="lv-weekdays" class="hidden">
                    <label class="text-xs text-stone-500 font-bold uppercase mb-1 block">é‡è¤‡æ˜ŸæœŸ (å¯å¤šé¸)</label>
                    <div class="flex justify-between gap-1">
                        <input type="checkbox" id="wd-1" class="hidden chk-btn" value="1"><label for="wd-1" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">ä¸€</label>
                        <input type="checkbox" id="wd-2" class="hidden chk-btn" value="2"><label for="wd-2" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">äºŒ</label>
                        <input type="checkbox" id="wd-3" class="hidden chk-btn" value="3"><label for="wd-3" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">ä¸‰</label>
                        <input type="checkbox" id="wd-4" class="hidden chk-btn" value="4"><label for="wd-4" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">å››</label>
                        <input type="checkbox" id="wd-5" class="hidden chk-btn" value="5"><label for="wd-5" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">äº”</label>
                        <input type="checkbox" id="wd-6" class="hidden chk-btn" value="6"><label for="wd-6" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">å…­</label>
                        <input type="checkbox" id="wd-0" class="hidden chk-btn" value="0"><label for="wd-0" class="flex-1 py-2 text-center text-xs font-bold bg-stone-50 border border-stone-200 rounded cursor-pointer select-none">æ—¥</label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-stone-500 font-bold uppercase">å‡åˆ¥</label><select id="lv-type" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"><option value="äº‹å‡">äº‹å‡</option><option value="ç—…å‡">ç—…å‡</option><option value="æ’ä¼‘">æ’ä¼‘</option></select></div>
                    <div><label class="text-xs text-stone-500 font-bold uppercase">ç­æ¬¡</label><select id="lv-period" class="w-full border border-stone-200 rounded-lg p-2.5 mt-1 bg-stone-50"><option value="all">å…¨å¤©</option><option value="æ—©ç­">æ—©ç­</option><option value="ç™½ç­">ç™½ç­</option><option value="æ™šç­">æ™šç­</option></select></div>
                </div>
            </div>
            <div class="p-5 bg-stone-50 border-t border-stone-100 flex gap-3">
                <button onclick="document.getElementById('leave-modal').classList.add('hidden')" class="flex-1 py-3 text-stone-500 bg-white border border-stone-200 rounded-xl font-bold shadow-sm">å–æ¶ˆ</button>
                <button onclick="saveLeave()" class="flex-1 py-3 bg-coffee-600 text-white rounded-xl font-bold shadow-md">ç¢ºèªç™»è¨˜</button>
            </div>
        </div>
    </div>

    <!-- Day Schedule Modal -->
    <div id="day-modal" class="fixed inset-0 bg-stone-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden h-[70vh] flex flex-col">
            <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                <h3 class="font-bold text-coffee-800" id="day-modal-title">æ—¥æœŸ</h3>
                <button onclick="document.getElementById('day-modal').classList.add('hidden')" class="text-stone-400 px-2 font-bold">âœ•</button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto space-y-4">
                <div><h4 class="text-xs font-bold text-stone-400 uppercase mb-2">ç•¶æ—¥ç­è¡¨</h4><div id="day-shift-list" class="space-y-2"></div></div>
                <div><h4 class="text-xs font-bold text-stone-400 uppercase mb-2">ç•¶æ—¥è«‹å‡</h4><div id="day-leave-list" class="space-y-2 text-sm text-stone-500"></div></div>
            </div>
            <div class="p-4 bg-stone-50 border-t border-stone-100">
                <div class="flex gap-2">
                    <select id="day-add-emp" class="flex-1 border border-stone-200 rounded-lg p-2 text-sm outline-none"></select>
                    <select id="day-add-shift" class="w-24 border border-stone-200 rounded-lg p-2 text-sm outline-none"><option value="æ—©ç­">æ—©ç­</option><option value="ç™½ç­">ç™½ç­</option><option value="æ™šç­">æ™šç­</option></select>
                    <button onclick="saveDaySchedule()" class="bg-coffee-600 text-white px-3 rounded-lg text-sm font-bold shadow-sm">æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================================
        // âš ï¸ é‡è¦ï¼šæ­£å¼ä¸Šç·šå‰ï¼Œè«‹å°‡ä¸‹æ–¹çš„ firebaseConfig æ›¿æ›ç‚ºæ‚¨åœ¨
        // xuxu-helper å°ˆæ¡ˆå–å¾—çš„çœŸå¯¦è¨­å®šï¼
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyATncVLAIoz28OJxLKk4zHQInSfqOvCLik",
          authDomain: "xuxu-helper.firebaseapp.com",
          projectId: "xuxu-helper",
          storageBucket: "xuxu-helper.firebasestorage.app",
          messagingSenderId: "1022083747734",
          appId: "1:1022083747734:web:e5ea9af8d1cbc8554e97b7",
          measurementId: "G-8Q10D83PMQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================================
        // è³‡æ–™åº«è·¯å¾‘è¨­å®š (Data Path)
        // ç‚ºäº†åœ¨ GitHub Pages æ­£å¼é‹ä½œï¼Œæˆ‘å€‘ä½¿ç”¨æ ¹ç›®éŒ„è·¯å¾‘ã€‚
        // å¦‚æœæ‚¨åœ¨é è¦½ç’°å¢ƒï¼Œæœƒè‡ªå‹•åˆ‡æ›ç‚ºæ²™ç›’è·¯å¾‘ã€‚
        // ============================================================
        const getCollection = (colName) => {
             // æ­£å¼æ¨¡å¼ (GitHub Pages / Vercel)
             // ç›´æ¥å­˜å–æ ¹ç›®éŒ„ï¼Œæ‰€æœ‰ç™»å…¥è€…å…±äº«è³‡æ–™ (é©åˆå–®ä¸€åº—é‹ª)
             return collection(db, colName);
        };

        const getDocRef = (colName, id) => {
             return doc(db, colName, id);
        };

        const CONFIG = {
            fixedCost: 1200000, rent: 114597, mgmt: 5359, defaultIncome: 100000,
            items: ['è±†æ¼¿', 'ç‰›å¥¶', 'é®®å¥¶æ²¹', 'ç´…è±†', 'è–ä»', 'ç´«ç±³', 'ç³¯ç±³', 'è±†çš®', 'èŠ‹åœ“', 'æ¹¯åœ“', 'æœ¨è–¯', 'è“®è—•', 'ç ‚ç³–', 'é»ƒå†°ç³–', 'ç³¯ç±³ç²‰', 'æœ¨è–¯æ¾±ç²‰'],
            colors: ['#8B4513', '#A0522D', '#CD853F', '#D2691E', '#DEB887', '#F4A460', '#BC8F8F', '#808000'],
            shifts: [
                { name: 'æ—©ç­', code: 'æ—©', time: '08:00-12:00', start: 8, end: 12, order: 1, count: 1, color: 'text-blue-600' },
                { name: 'ç™½ç­', code: 'ç™½', time: '11:30-15:30', start: 11.5, end: 15.5, order: 2, count: 2, color: 'text-yellow-600' },
                { name: 'æ™šç­', code: 'æ™š', time: '16:30-20:30', start: 16.5, end: 20.5, order: 3, count: 2, color: 'text-purple-600' }
            ]
        };

        const HOLIDAYS = {
            '2025-01-01': 'å…ƒæ—¦', '2025-01-25': 'æ˜¥ç¯€', '2025-01-26': 'æ˜¥ç¯€', '2025-01-27': 'é™¤å¤•', '2025-01-28': 'æ˜¥ç¯€',
            '2025-01-29': 'æ˜¥ç¯€', '2025-01-30': 'æ˜¥ç¯€', '2025-01-31': 'æ˜¥ç¯€', '2025-02-01': 'æ˜¥ç¯€', '2025-02-02': 'æ˜¥ç¯€',
            '2025-02-28': '228', '2025-04-03': 'å…’ç¯€', '2025-04-04': 'æ¸…æ˜', '2025-04-05': 'é€£å‡', '2025-04-06': 'é€£å‡',
            '2025-05-01': 'å‹å‹•', '2025-05-30': 'ç«¯åˆ', '2025-05-31': 'ç«¯åˆ', '2025-06-01': 'ç«¯åˆ',
            '2025-09-27': 'æ•™å¸«', '2025-09-28': 'æ•™å¸«', '2025-09-29': 'æ•™å¸«',
            '2025-10-04': 'ä¸­ç§‹', '2025-10-05': 'ä¸­ç§‹', '2025-10-06': 'ä¸­ç§‹', '2025-10-10': 'åœ‹æ…¶', '2025-10-11': 'åœ‹æ…¶', '2025-10-12': 'åœ‹æ…¶',
            '2025-10-24': 'å…‰å¾©', '2025-10-25': 'å…‰å¾©', '2025-10-26': 'å…‰å¾©', '2025-12-25': 'è¡Œæ†²'
        };

        let state = {
            user: null, transactions: [], employees: [], leaves: [], shifts: [], attendance: [], notices: [],
            currentMonth: new Date().toISOString().slice(0, 7),
            type: 'out', view: 'home', reportView: 'chart', reportPeriod: 'month',
            selectedDate: null, leaveMode: 'single', listTab: 'tx'
        };

        const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; }
        const getEl = (id) => document.getElementById(id);
        const formatMoney = (n) => new Intl.NumberFormat('zh-TW', {style:'currency', currency: 'TWD', maximumFractionDigits: 0}).format(n);

        const initAuth = async () => {
            // å˜—è©¦ä½¿ç”¨åŒ¿åç™»å…¥ä»¥å­˜å–è³‡æ–™åº« (éœ€ç¢ºèª Firebase Console å·²é–‹å•ŸåŒ¿åç™»å…¥)
            // è‡ªå‹•ä¿®å¾©ï¼šå¦‚æœè‡ªè¨‚ Token å¤±æ•—ï¼ˆå› è¨­å®šæª”ä¸ç¬¦ï¼‰ï¼Œå‰‡è‡ªå‹•è½‰ç‚ºåŒ¿åç™»å…¥
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                     throw new Error('No token');
                }
            } catch (e) {
                console.log("Token auth failed, falling back to anonymous:", e);
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                const collections = ['transactions', 'employees', 'leaves', 'shifts', 'attendance', 'notices'];
                collections.forEach(col => {
                    onSnapshot(getCollection(col), (snapshot) => {
                        const data = []; snapshot.forEach((doc) => data.push({ id: doc.id, ...doc.data() }));
                        if(col === 'transactions' || col === 'attendance' || col === 'notices') data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                        state[col] = data;
                        
                        if(col === 'transactions') checkLoad();
                        
                        // Re-render
                        if(state.view === 'report') renderReport();
                        else if(state.view === 'staff') renderStaff();
                        else if(state.view === 'schedule') renderSchedule();
                        else if(state.view === 'home') { render(); renderNotices(); }
                        else if(state.view === 'list') { renderList(); render(); }
                        
                        if(!getEl('day-modal').classList.contains('hidden') && state.selectedDate) openDayModal(state.selectedDate);
                    });
                });
            }
        });

        const checkLoad = () => {
            const overlay = getEl('loading-overlay');
            if (overlay) { overlay.classList.add('opacity-0'); setTimeout(() => { if(overlay && overlay.parentNode) overlay.remove(); }, 300); }
        };

        const getRange=(p,a)=>{const y=parseInt(a.slice(0,4)),m=parseInt(a.slice(5,7));const fmt=(y,m)=>`${y}-${String(m).padStart(2,'0')}`;if(p==='month'){const pm=m===1?12:m-1,py=m===1?y-1:y;return{start:fmt(y,m),end:fmt(y,m),pStart:fmt(py,pm),pEnd:fmt(py,pm)}}else if(p==='year'){return{start:fmt(y,1),end:fmt(y,12),pStart:fmt(y-1,1),pEnd:fmt(y-1,12)}}return{start:fmt(y,m),end:fmt(y,m),pStart:fmt(y,m),pEnd:fmt(y,m)};}; 
        const calcStats=(txs,s,e)=>{const rel=txs.filter(t=>t.date.slice(0,7)>=s&&t.date.slice(0,7)<=e);let i=0,ex=0,st={};rel.forEach(t=>{if(t.type==='in')i+=t.amount;else{ex+=t.amount;if(t.cat==='stock'){if(!st[t.name])st[t.name]={qty:0,cost:0,unit:t.unit};st[t.name].qty+=(t.qty||0);st[t.name].cost+=t.amount;}}});return{inc:i,exp:ex,net:i-ex,stock:st,txs:rel};};

        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            const R = 6371; const dLat = deg2rad(lat2-lat1); const dLon = deg2rad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        window.simulateCheckIn = async () => {
             if(!state.employees.length) return Modal.show({type:'alert', message:'ç„¡å“¡å·¥è³‡æ–™'});
             const emp = state.employees[0];
             const now = new Date();
             const timeStr = now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
             await addDoc(getCollection('attendance'), {
                 name: emp.name, date: now.toISOString().slice(0,10), time: timeStr, status: 'æº–æ™‚', createdAt: Date.now()
             });
             Modal.show({type:'alert', message:`[æ¨¡æ“¬] ${emp.name} æ–¼ ${timeStr} æ‰“å¡æˆåŠŸï¼`});
        };

        // --- Notices ---
        window.addNotice = () => {
             getEl('modal-notice-inputs').classList.remove('hidden');
             Modal.show({
                 type: 'notice', // Special type for notice inputs
                 title: 'ç™¼å¸ƒå…¬å‘Š',
                 message: 'è«‹è¼¸å…¥å…§å®¹',
                 onConfirm: async () => {
                    const title = getEl('notice-title').value;
                    const content = getEl('notice-content').value;
                    const priority = getEl('notice-priority').value;
                    if(!title || !content) return;
                    await addDoc(getCollection('notices'), {
                        title, content, priority, date: new Date().toISOString().slice(0,10), createdAt: Date.now()
                    });
                    getEl('notice-title').value = ''; getEl('notice-content').value = '';
                    getEl('modal-notice-inputs').classList.add('hidden');
                 }
             });
        };

        window.deleteNotice = async (id) => {
            Modal.show({
                type: 'confirm',
                title: 'åˆªé™¤å…¬å‘Š',
                message: 'ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿ',
                onConfirm: async () => {
                    await deleteDoc(getDocRef('notices', id));
                }
            });
        };

        function renderNotices() {
            const list = getEl('notice-list'); if(!list) return; list.innerHTML = '';
            if(state.notices.length === 0) getEl('notice-empty').classList.remove('hidden');
            else {
                getEl('notice-empty').classList.add('hidden');
                state.notices.forEach(n => {
                    const div = document.createElement('div');
                    div.className = `notice-card ${n.priority} relative group`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm text-coffee-800">${n.title}</h4>
                                <span class="text-[10px] text-stone-400 block">${n.date}</span>
                            </div>
                            <button onclick="deleteNotice('${n.id}')" class="text-stone-300 hover:text-red-500 p-1 -mt-1 -mr-1 transition-colors">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <p class="text-xs text-stone-600 mt-1">${n.content}</p>`;
                    list.appendChild(div);
                });
            }
        }

        // --- Staff ---
        window.addEmployee = () => { getEl('st-name').value=''; getEl('st-color').value='#a67c52'; getEl('st-email').value=''; getEl('staff-modal').classList.remove('hidden'); };
        window.saveEmployee = async () => { 
            const name=getEl('st-name').value; const color=getEl('st-color').value; const role=getEl('st-role').value; const email=getEl('st-email').value;
            if(!name) return Modal.show({type:'alert',message:'è«‹è¼¸å…¥å§“å'}); 
            const data={name, role, color, email, phone:getEl('st-phone').value, addr:getEl('st-addr').value, emer:getEl('st-emer').value, date:getEl('st-date').value, wage:Number(getEl('st-wage').value)}; 
            await addDoc(getCollection('employees'), data); 
            getEl('staff-modal').classList.add('hidden'); 
        };
        window.deleteStaff = async (id) => { 
            Modal.show({type:'confirm',message:'åˆªé™¤å“¡å·¥?',onConfirm:async()=>{
                await deleteDoc(getDocRef('employees', id));
            }}); 
        };
        
        window.addLeave = () => { if(state.employees.length===0) return Modal.show({type:'alert',message:'ç„¡å“¡å·¥'}); const sel=getEl('lv-emp'); sel.innerHTML=''; state.employees.forEach(e=>{const o=document.createElement('option');o.value=e.name;o.textContent=e.name;sel.appendChild(o);}); window.switchLeaveMode('single'); getEl('leave-modal').classList.remove('hidden'); };
        window.switchLeaveMode = (m) => { state.leaveMode=m; ['single','range','recurring'].forEach(k=>{const btn=getEl('lm-'+k); if(k===m){btn.classList.add('bg-white','shadow-sm','text-coffee-800');btn.classList.remove('text-stone-400');}else{btn.classList.remove('bg-white','shadow-sm','text-coffee-800');btn.classList.add('text-stone-400');}}); if(m==='single'){getEl('lv-date-single').classList.remove('hidden');getEl('lv-date-range').classList.add('hidden');getEl('lv-weekdays').classList.add('hidden');}else{getEl('lv-date-single').classList.add('hidden');getEl('lv-date-range').classList.remove('hidden'); if(m==='recurring') getEl('lv-weekdays').classList.remove('hidden'); else getEl('lv-weekdays').classList.add('hidden');} };
        
        window.saveLeave = async () => { 
            const name=getEl('lv-emp').value, type=getEl('lv-type').value, period=getEl('lv-period').value; 
            const leaves=[];
            if(state.leaveMode==='single'){
                const d=getEl('lv-date').value; if(!d)return Modal.show({type:'alert',message:'è«‹é¸æ—¥æœŸ'}); leaves.push(d);
            } else {
                const s=getEl('lv-start').value, e=getEl('lv-end').value; if(!s||!e)return Modal.show({type:'alert',message:'è«‹é¸æ—¥æœŸ'});
                const start=new Date(s), end=new Date(e);
                for(let dt=start; dt<=end; dt.setDate(dt.getDate()+1)){
                    if(state.leaveMode==='recurring'){ const day=dt.getDay(); if(!getEl('wd-'+day).checked) continue; }
                    leaves.push(dt.toISOString().slice(0,10));
                }
            }
            if(leaves.length===0) return Modal.show({type:'alert',message:'ç„¡æœ‰æ•ˆæ—¥æœŸ'});
            
            for(const d of leaves) {
                const existing = state.leaves.find(l => l.name === name && l.date === d);
                if (existing) {
                    if (existing.period === 'all' || period === 'all' || existing.period === period) {
                        return Modal.show({type:'alert',message:`${d} è©²å“¡å·¥å·²æœ‰è«‹å‡ç´€éŒ„ (${existing.period})ï¼Œç„¡æ³•é‡è¤‡ç™»è¨˜ã€‚`});
                    }
                }
            }

            const col=getCollection('leaves');
            Modal.show({type:'alert',message:`æ­£åœ¨å»ºç«‹ ${leaves.length} ç­†è«‹å‡...`,autoClose:1000});
            for(const d of leaves) await addDoc(col, {name, date:d, type, period});
            getEl('leave-modal').classList.add('hidden');
        };
        window.deleteLeave = async (id) => { 
            Modal.show({type:'confirm',message:'å–æ¶ˆè«‹å‡?',onConfirm:async()=>{
                await deleteDoc(getDocRef('leaves', id));
            }}); 
        };

        window.autoSchedule = async () => {
            if(state.employees.length === 0) return Modal.show({ type: 'alert', message: 'ç„¡å“¡å·¥å¯æ’ç­' });
            Modal.show({
                type: 'confirm',
                message: `ç¢ºå®šè¦ç‚º ${state.currentMonth} é‡æ–°æ’ç­ï¼Ÿ\n(æ³¨æ„ï¼šèˆŠç­è¡¨å°‡è¢«æ¸…é™¤ä¸¦é‡æ–°ç”¢ç”Ÿ)`,
                onConfirm: async () => {
                    const shiftCollection = getCollection('shifts');
                    const shiftsToDelete = state.shifts.filter(s => s.date.startsWith(state.currentMonth));
                    for (const shift of shiftsToDelete) { await deleteDoc(getDocRef('shifts', shift.id)); }

                    const [year, month] = state.currentMonth.split('-');
                    const daysInMonth = new Date(year, month, 0).getDate();
                    let count = 0;

                    for(let d=1; d<=daysInMonth; d++) {
                        const dateStr = `${state.currentMonth}-${String(d).padStart(2,'0')}`;
                        let dailySchedule = []; 

                        for (const shiftType of CONFIG.shifts) {
                            const shiftStart = shiftType.start; const shiftEnd = shiftType.end; const reqStart = shiftStart - 1; 
                            let needed = shiftType.count;
                            
                            for(let i=0; i<needed; i++) {
                                const candidates = state.employees.filter(emp => {
                                    if (shiftType.code === 'æ—©' && emp.role === 'ç³–äº‹äºº') return false; 
                                    const leave = state.leaves.find(l => l.date === dateStr && l.name === emp.name);
                                    if (leave) {
                                        if (leave.period === 'all') return false;
                                        const leaveShift = CONFIG.shifts.find(s => s.name === leave.period);
                                        if (leaveShift && reqStart < leaveShift.end && shiftEnd > leaveShift.start) return false;
                                    }
                                    const workedShifts = dailySchedule.filter(s => s.name === emp.name);
                                    if (workedShifts.length >= 2) return false; 

                                    for (const worked of workedShifts) {
                                        const workedType = CONFIG.shifts.find(s => s.name === worked.shift);
                                        if (shiftStart < workedType.end && shiftEnd > workedType.start) return false;
                                    }

                                    let consecutive = 0;
                                    for(let back=1; back<=6; back++) {
                                        const pastDate = new Date(year, month-1, d-back);
                                        const pStr = pastDate.toISOString().slice(0,10);
                                        const workedPast = state.shifts.find(s => s.date === pStr && s.name === emp.name);
                                        if(workedPast) consecutive++; else break;
                                    }
                                    if (consecutive >= 6) return false; 

                                    return true;
                                });

                                if(candidates.length > 0) {
                                    const pick = candidates[Math.floor(Math.random() * candidates.length)];
                                    await addDoc(shiftCollection, { date: dateStr, name: pick.name, shift: shiftType.name, time: shiftType.time, code: shiftType.code });
                                    dailySchedule.push({ name: pick.name, shift: shiftType.name });
                                    count++;
                                }
                            }
                        }
                    }
                    Modal.show({ type: 'alert', message: `æ’ç­å®Œæˆï¼(æ–°å¢ ${count} ç­æ¬¡)` });
                }
            });
        };
        
        window.clearSchedule = () => {
             Modal.show({
                type: 'confirm',
                title: 'æ¸…ç©ºç­è¡¨',
                message: `ç¢ºå®šè¦æ¸…ç©º ${state.currentMonth} çš„æ‰€æœ‰æ’ç­å—ï¼Ÿ\n(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)`,
                onConfirm: async () => {
                    const shiftsToDelete = state.shifts.filter(s => s.date.startsWith(state.currentMonth));
                    if (shiftsToDelete.length === 0) return Modal.show({ type: 'alert', message: 'æœ¬æœˆç„¡ç­è¡¨å¯æ¸…é™¤' });
                    for (const shift of shiftsToDelete) { await deleteDoc(getDocRef('shifts', shift.id)); }
                    Modal.show({ type: 'alert', message: 'å·²æ¸…ç©ºæœ¬æœˆç­è¡¨', autoClose: 1000 });
                }
            });
        };

        window.openDayModal = (dateStr) => {
            state.selectedDate = dateStr;
            getEl('day-modal').classList.remove('hidden');
            setText('day-modal-title', `${dateStr} ç­è¡¨è©³æƒ…`);
            
            const sList = getEl('day-shift-list'); sList.innerHTML = '';
            // SORT SHIFTS
            const shifts = state.shifts.filter(s => s.date === dateStr);
            const shiftOrder = { 'æ—©ç­': 1, 'ç™½ç­': 2, 'æ™šç­': 3 };
            shifts.sort((a, b) => (shiftOrder[a.shift] || 99) - (shiftOrder[b.shift] || 99));

            if (shifts.length === 0) sList.innerHTML = '<div class="text-xs text-stone-400 italic">æœ¬æ—¥ç„¡æ’ç­</div>';
            else {
                shifts.forEach(s => {
                    // Find Employee Color
                    const emp = state.employees.find(e => e.name === s.name) || {color:'#a67c52'};
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-stone-50 p-2 rounded-lg border border-stone-100 text-sm";
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color:${emp.color}"></span>
                            <span class="font-bold" style="color:${emp.color}">${s.name}</span>
                            <span class="text-xs text-stone-400">(${s.shift})</span>
                        </div>
                        <button onclick="deleteShift('${s.id}')" class="text-red-400 text-xs font-bold px-2 py-1 bg-red-50 rounded">åˆªé™¤</button>
                    `;
                    sList.appendChild(div);
                });
            }
            const lList = getEl('day-leave-list'); lList.innerHTML = '';
            const leaves = state.leaves.filter(l => l.date === dateStr);
            if (leaves.length === 0) lList.innerHTML = 'ç„¡';
            else {
                leaves.forEach(l => {
                    const div = document.createElement('div');
                    div.className = "bg-stone-50 p-2 rounded text-stone-500 text-xs";
                    div.textContent = `${l.name} (${l.type} - ${l.period === 'all' ? 'å…¨å¤©' : l.period})`;
                    lList.appendChild(div);
                });
            }
            const empSel = getEl('day-add-emp'); empSel.innerHTML = '';
            state.employees.forEach(e => { const opt = document.createElement('option'); opt.value = e.name; opt.textContent = e.name; empSel.appendChild(opt); });
        };
        
        window.saveDaySchedule = async () => {
            const name = getEl('day-add-emp').value;
            const shiftName = getEl('day-add-shift').value;
            if (!name || !state.selectedDate) return;

            // 1. æª¢æŸ¥è«‹å‡è¡çª
            const leave = state.leaves.find(l => l.date === state.selectedDate && l.name === name);
            if (leave) {
                if (leave.period === 'all' || leave.period === shiftName) {
                    return Modal.show({ type: 'alert', message: `âš ï¸ ${name} ç•¶å¤©å·²æœ‰ã€Œ${leave.period}ã€è«‹å‡ï¼` });
                }
            }
            
            // 2. æª¢æŸ¥é‡è¤‡æ’ç­ (åŒä¸€å“¡å·¥ç•¶å¤©ä¸èƒ½æœ‰ç›¸åŒç­æ¬¡)
            const existingSameShift = state.shifts.find(s => s.date === state.selectedDate && s.name === name && s.shift === shiftName);
            if (existingSameShift) return Modal.show({ type: 'alert', message: `âš ï¸ ${name} ç•¶å¤©å·²ç¶“æœ‰ã€Œ${shiftName}ã€äº†ï¼` });

            // 3. æª¢æŸ¥å·¥æ™‚é‡ç–Š (é˜²å‘†ï¼šæ—©ç­ä¸èƒ½æ¥ç™½ç­)
            const shiftType = CONFIG.shifts.find(s => s.name === shiftName);
            const dailyWork = state.shifts.filter(s => s.date === state.selectedDate && s.name === name);
            for (const worked of dailyWork) {
                 const workedType = CONFIG.shifts.find(s => s.name === worked.shift);
                 if (shiftType.start < workedType.end && shiftType.end > workedType.start) {
                     return Modal.show({ type: 'alert', message: `âš ï¸ æ™‚é–“è¡çª\n\n${name} å·²æ’ã€Œ${worked.shift}ã€ï¼Œæ™‚é–“é‡ç–Šç„¡æ³•æ’ã€Œ${shiftName}ã€ï¼` });
                }
            }

            await addDoc(getCollection('shifts'), { date: state.selectedDate, name, shift: shiftName, time: shiftType.time, code: shiftType.code });
        };
        
        window.deleteShift = async (id) => { 
            await deleteDoc(getDocRef('shifts', id));
        };

        window.switchMainTab = (view) => {
            state.view = view;
            ['home','report','schedule','staff','list'].forEach(v => {
                const el=getEl('view-'+v), nav=getEl('nav-'+v);
                if(v===view){ if(el) el.classList.remove('hidden'); if(nav) {nav.classList.add('text-coffee-600'); nav.classList.remove('text-stone-400');} }
                else{ if(el) el.classList.add('hidden'); if(nav) {nav.classList.remove('text-coffee-600'); nav.classList.add('text-stone-400');} }
            });
            if(view==='report') renderReport(); if(view==='staff') renderStaff(); if(view==='schedule') renderSchedule(); if(view==='home' || view==='list') { render(); if(view==='list') renderList(); if(view==='home') renderNotices(); }
        }
        
        window.switchListTab = (tab) => {
            state.listTab = tab;
            if(tab === 'tx') {
                getEl('list-tx-container').classList.remove('hidden');
                getEl('list-attn-container').classList.add('hidden');
                getEl('ltab-tx').classList.add('border-coffee-600', 'text-coffee-700'); getEl('ltab-tx').classList.remove('border-transparent', 'text-stone-400');
                getEl('ltab-attn').classList.remove('border-coffee-600', 'text-coffee-700'); getEl('ltab-attn').classList.add('border-transparent', 'text-stone-400');
            } else {
                getEl('list-tx-container').classList.add('hidden');
                getEl('list-attn-container').classList.remove('hidden');
                getEl('ltab-attn').classList.add('border-coffee-600', 'text-coffee-700'); getEl('ltab-attn').classList.remove('border-transparent', 'text-stone-400');
                getEl('ltab-tx').classList.remove('border-coffee-600', 'text-coffee-700'); getEl('ltab-tx').classList.add('border-transparent', 'text-stone-400');
            }
        }

        // ... Transaction & Render Logic ...
        window.addTransaction = async () => { if (!state.user) return; const amt = getEl('amount-input').value; if (!amt) return Modal.show({type:'alert',message:'è«‹è¼¸å…¥é‡‘é¡'}); let name='', cat='', qty=0, unit=''; if (state.type === 'out') { cat = getEl('cat-select').value; if (cat === 'stock') { name = getEl('item-select').value; qty = Number(getEl('qty-input').value)||0; unit = getEl('unit-input').value; } else if(cat==='rent') name='æˆ¿ç§Ÿ'; else if(cat==='mgmt') name='ç®¡ç†è²»'; else name=getEl('custom-note').value||'é›œæ”¯'; } else { cat = 'sales'; name = getEl('income-note').value || 'ç‡Ÿæ”¶'; } 
        await addDoc(getCollection('transactions'), { date: state.currentMonth+'-'+new Date().getDate().toString().padStart(2,'0'), type: state.type, name, cat, amount: Number(amt), qty, unit, createdAt: Date.now() }); getEl('amount-input').value=''; Modal.show({type:'alert',message:'å·²å„²å­˜',autoClose:800}); };
        
        window.safeAddFixedCost = () => { if(!state.user)return; Modal.show({type:'confirm',title:'å¿«é€Ÿ',message:'åŠ å…¥æˆ¿ç§Ÿç®¡ç†è²»?',onConfirm:async()=>{const r=getCollection('transactions'),n=Date.now();await addDoc(r,{date:state.currentMonth+'-05',type:'out',name:'æˆ¿ç§Ÿ',amount:CONFIG.rent,cat:'rent',createdAt:n});await addDoc(r,{date:state.currentMonth+'-05',type:'out',name:'ç®¡ç†è²»',amount:CONFIG.mgmt,cat:'mgmt',createdAt:n+1});Modal.show({type:'alert',message:'OK',autoClose:800});}}); };
        window.safeAddFixedIncome = () => { if(!state.user)return; Modal.show({type:'prompt',title:'é ä¼°ç‡Ÿæ”¶',message:'é‡‘é¡:',defaultValue:CONFIG.defaultIncome,onConfirm:async(v)=>{const n=Number(v);if(!n)return;await addDoc(getCollection('transactions'),{date:state.currentMonth+'-01',type:'in',name:'é ä¼°ç‡Ÿæ”¶',amount:n,cat:'sales',createdAt:Date.now()});Modal.show({type:'alert',message:'OK',autoClose:800});}}); };
        window.safeDeleteTx = (id) => { if(!state.user)return; Modal.show({type:'confirm',title:'åˆªé™¤',message:'ç¢ºå®š?',onConfirm:async()=>{await deleteDoc(getDocRef('transactions', id));}}); };
        window.setType=t=>{state.type=t; const i=getEl('btn-in'),o=getEl('btn-out'),io=getEl('income-options'),eo=getEl('expense-options'); if(t==='in'){i.className="flex-1 py-2.5 rounded-lg text-sm font-bold bg-green-600 text-white shadow-sm";o.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400";io.classList.remove('hidden');eo.classList.add('hidden');}else{o.className="flex-1 py-2.5 rounded-lg text-sm font-bold bg-red-400 text-white shadow-sm";i.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400";eo.classList.remove('hidden');io.classList.add('hidden');}};
        window.updateItemSelect=()=>{const cat=getEl('cat-select').value,is=getEl('item-select'),ci=getEl('custom-note'),ar=getEl('select-arrow'),sd=getEl('stock-details'); is.innerHTML=''; if(cat==='stock'){is.classList.remove('hidden');ar.classList.remove('hidden');ci.classList.add('hidden');sd.classList.remove('hidden');CONFIG.items.forEach(i=>{const o=document.createElement('option');o.value=i;o.textContent=i;is.appendChild(o);});}else{sd.classList.add('hidden');if(['rent','mgmt'].includes(cat)){is.classList.add('hidden');ar.classList.add('hidden');ci.classList.add('hidden');}else{is.classList.add('hidden');ar.classList.add('hidden');ci.classList.remove('hidden');}}};
        window.switchReportTab = (v) => { state.reportView = v; const c=getEl('report-chart'), s=getEl('report-stock'), a=getEl('report-attn'), bc=getEl('subtab-chart'), bs=getEl('subtab-stock'), ba=getEl('subtab-attn'); if(v==='chart'){c.classList.remove('hidden');s.classList.add('hidden');a.classList.add('hidden');bc.className="flex-1 py-2 text-sm font-bold text-coffee-700 border-b-2 border-coffee-600";bs.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";ba.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";}else if(v==='stock'){s.classList.remove('hidden');c.classList.add('hidden');a.classList.add('hidden');bs.className="flex-1 py-2 text-sm font-bold text-coffee-700 border-b-2 border-coffee-600";bc.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";ba.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";}else{a.classList.remove('hidden');c.classList.add('hidden');s.classList.add('hidden');ba.className="flex-1 py-2 text-sm font-bold text-coffee-700 border-b-2 border-coffee-600";bc.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";bs.className="flex-1 py-2 text-sm font-bold text-stone-400 border-b-2 border-transparent";} };
        window.changeReportPeriod = (p) => { state.reportPeriod = p; ['month','quarter','half','year'].forEach(k => { getEl('rp-'+k).className = k===p ? "flex-1 py-1.5 rounded-lg text-xs font-bold bg-white text-coffee-700 shadow-sm transition-all" : "flex-1 py-1.5 rounded-lg text-xs font-bold text-stone-500 transition-all"; }); renderReport(); }

        function renderStaff() {
            const list = getEl('staff-list'); if(!list) return; list.innerHTML = '';
            if(state.employees.length === 0) return getEl('staff-empty').classList.remove('hidden');
            getEl('staff-empty').classList.add('hidden');
            state.employees.forEach(e => {
                const myShifts = state.shifts.filter(s => s.name === e.name && s.date.startsWith(state.currentMonth));
                let totalHours = 0, holidayHours = 0;
                myShifts.forEach(s => { if (HOLIDAYS[s.date]) holidayHours += 4; else totalHours += 4; });
                let bonus = 0; const totalWork = totalHours + holidayHours;
                if (totalWork >= 160) bonus = 2000; else if (totalWork >= 120) bonus = 1500; else if (totalWork >= 80) bonus = 1000; else if (totalWork >= 40) bonus = 500;
                const baseWage = e.wage || 183; const salary = (totalHours * baseWage) + (holidayHours * baseWage * 2); const totalPay = salary + bonus;
                const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow-sm border border-stone-100";
                div.innerHTML = `<div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2"><span class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs" style="background-color: ${e.color || '#a67c52'}">${e.name[0]}</span><div><div class="font-bold text-coffee-800 text-lg flex items-center gap-1">${e.name}<span class="role-tag bg-stone-100 text-stone-500">${e.role==='æœ¨ç™½åŒ '?'åŒ ':'ç³–'}</span><span class="text-[9px] text-gray-300 ml-1 font-normal">${e.email?'ğŸ”—':''}</span></div><div class="text-xs text-stone-500">æ™‚è–ª $${baseWage}</div></div></div><button onclick="deleteStaff('${e.id}')" class="text-stone-300 hover:text-red-500 text-sm">âœ•</button></div><div class="grid grid-cols-2 gap-2 text-center bg-stone-50 rounded-lg p-2 text-xs mb-2"><div class="text-stone-500">ä¸€èˆ¬æ™‚æ•¸: <span class="font-bold text-coffee-700">${totalHours}h</span></div><div class="text-stone-500">åœ‹å®šå‡æ—¥: <span class="font-bold text-red-500">${holidayHours}h</span></div></div><div class="grid grid-cols-2 gap-2 text-center bg-stone-50 rounded-lg p-2"><div><div class="text-[10px] text-stone-400">æ¿€å‹µçé‡‘</div><div class="font-bold text-green-600">+$${bonus}</div></div><div><div class="text-[10px] text-stone-400">é ä¼°è–ªè³‡</div><div class="font-bold text-coffee-900">$${totalPay.toLocaleString()}</div></div></div>`;
                list.appendChild(div);
            });
        }

        function renderSchedule() {
            const cal = getEl('schedule-calendar'); if(!cal) return; cal.innerHTML = '';
            const [year, month] = state.currentMonth.split('-'); const firstDay = new Date(year, month-1, 1).getDay(); const daysInMonth = new Date(year, month, 0).getDate();
            for(let i=0; i<firstDay; i++) cal.appendChild(document.createElement('div'));
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${state.currentMonth}-${String(d).padStart(2,'0')}`;
                const cell = document.createElement('div'); cell.className = "calendar-cell"; cell.onclick = () => openDayModal(dateStr);
                const holidayName = HOLIDAYS[dateStr] ? `<span class="holiday-tag">${HOLIDAYS[dateStr]}</span>` : '';
                cell.innerHTML = `<span class="day-number">${d}${holidayName}</span>`;
                
                // --- Shift Grouping Display ---
                const dailyShifts = state.shifts.filter(s => s.date === dateStr);
                const groups = { 'æ—©ç­': [], 'ç™½ç­': [], 'æ™šç­': [] };
                dailyShifts.forEach(s => { if(groups[s.shift]) groups[s.shift].push(s.name); });

                ['æ—©ç­', 'ç™½ç­', 'æ™šç­'].forEach(shiftName => {
                    const names = groups[shiftName];
                    if (names.length > 0) {
                        const shiftConf = CONFIG.shifts.find(s => s.name === shiftName);
                        // Sort names inside the shift line alphabetically
                        names.sort();
                        
                        // Generate Colored Names
                        const coloredNames = names.map(n => {
                            const emp = state.employees.find(e => e.name === n) || {color: '#57534e'};
                            return `<span class="emp-name" style="color: ${emp.color}">${n}</span>`;
                        }).join(', ');

                        const row = document.createElement('div');
                        row.className = "shift-row";
                        row.innerHTML = `<span class="shift-label">${shiftConf.code}:</span> ${coloredNames}`;
                        cell.appendChild(row);
                    }
                });

                // Leave Dots
                state.leaves.filter(l => l.date === dateStr).forEach(l => {
                    const row = document.createElement('div');
                    row.className = "shift-row";
                    row.style.background = '#f5f5f4'; // Gray bg for leave
                    row.innerHTML = `<span class="shift-label text-stone-400">å‡:</span> <span class="text-stone-400 text-[9px]">${l.name}</span>`;
                    cell.appendChild(row);
                });

                cal.appendChild(cell);
            }
            const lList = getEl('leave-list'); if(lList){ lList.innerHTML = ''; const mLeaves = state.leaves.filter(l => l.date.startsWith(state.currentMonth)).sort((a,b)=>a.date.localeCompare(b.date)); if(mLeaves.length === 0) getEl('leave-empty').classList.remove('hidden'); else { getEl('leave-empty').classList.add('hidden'); mLeaves.forEach(l => { const div = document.createElement('div'); div.className = "flex justify-between text-sm bg-stone-50 p-2 rounded-lg border border-stone-100"; div.innerHTML = `<span><span class="font-mono text-coffee-600 mr-2">${l.date.slice(5)}</span>${l.name} (${l.type}-${l.period==='all'?'å…¨å¤©':l.period})</span><button onclick="deleteLeave('${l.id}')" class="text-stone-300">âœ•</button>`; lList.appendChild(div); }); } }
        }

        function renderList() {
            const container = getEl('attendance-list'); if(!container) return; container.innerHTML = '';
            const attns = state.attendance.filter(a => a.date.startsWith(state.currentMonth));
            if(attns.length === 0) getEl('attn-empty-msg').classList.remove('hidden');
            else {
                getEl('attn-empty-msg').classList.add('hidden');
                attns.forEach(a => {
                    const div = document.createElement('div'); div.className = "flex justify-between items-center p-3 hover:bg-stone-50 transition-colors";
                    div.innerHTML = `<div class="flex gap-2 items-center"><span class="font-mono text-xs bg-stone-100 px-1 rounded">${a.date.slice(5)}</span><span class="font-bold text-coffee-800">${a.name}</span></div><div class="text-xs text-stone-500 flex items-center gap-1"><span>${a.time}</span><span class="text-green-600 bg-green-50 px-1 rounded">æº–æ™‚</span></div>`;
                    container.appendChild(div);
                });
            }
        }

        function render(){
            const dispInc = getEl('disp-income'); if(!dispInc) return;
            const c=state.transactions.filter(t=>t.date.startsWith(state.currentMonth));
            let i=0,e=0; c.forEach(t=>{if(t.type==='in')i+=t.amount;else e+=t.amount});
            const n=i-e; setText('disp-income', formatMoney(i)); setText('disp-expense', formatMoney(e));
            const ne=getEl('disp-net'); if(ne){ ne.textContent=formatMoney(n); ne.className=`text-xl font-bold font-mono ${n>=0?'text-coffee-700':'text-red-500'}`; }
            let tn=0; state.transactions.forEach(t=>{if(t.type==='in')tn+=t.amount;else tn-=t.amount});
            const rm=CONFIG.fixedCost-tn; setText('disp-remaining', formatMoney(Math.max(0,rm)));
            const pb = getEl('progress-bar'); if(pb) pb.style.width=`${Math.min(100,Math.max(0,(tn/CONFIG.fixedCost)*100))}%`;
            const tb=getEl('transaction-list'); 
            if(tb) {
                tb.innerHTML='';
                if(c.length===0 && getEl('empty-msg')) getEl('empty-msg').classList.remove('hidden');
                else {
                    if(getEl('empty-msg')) getEl('empty-msg').classList.add('hidden');
                    c.forEach(t=>{
                        let nd=t.name; if(t.qty&&t.cat==='stock')nd+=` <span class="text-[10px] bg-orange-100 text-orange-800 px-1.5 py-0.5 rounded-full ml-1">${t.qty}${t.unit}</span>`;
                        const d=document.createElement('div');d.className="flex justify-between items-center p-4 hover:bg-stone-50 active:bg-stone-100 transition-colors";
                        d.innerHTML=`<div class="flex flex-col gap-1"><span class="text-xs text-stone-400 font-mono">${t.date.slice(5)}</span><span class="text-sm font-bold text-coffee-900 flex items-center"><span class="w-1.5 h-1.5 rounded-full mr-2 ${t.type==='in'?'bg-green-500':'bg-red-400'}"></span>${nd}</span></div><div class="flex items-center gap-3"><span class="font-bold font-mono text-base ${t.type==='in'?'text-green-600':'text-coffee-700'}">${formatMoney(t.amount)}</span><button onclick="safeDeleteTx('${t.id}')" class="text-stone-300 hover:text-red-500 p-2 -mr-2"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;
                        tb.appendChild(d);
                    });
                }
            }
        }

        function renderReport(){
            const rangeEl = getEl('report-date-range'); if(!rangeEl) return;
            const r=getRange(state.reportPeriod,state.currentMonth),c=calcStats(state.transactions,r.start,r.end),p=calcStats(state.transactions,r.pStart,r.pEnd);
            rangeEl.textContent=`${r.start} ~ ${r.end}`;
            const sc=(id,cv,pv)=>{const el=getEl(id+'-curr'); if(!el)return; el.textContent=formatMoney(cv);const d=cv-pv,pct=pv!==0?Math.round((d/Math.abs(pv))*100):(cv>0?100:0),cl=d>=0?'text-green-600':'text-red-500',ar=d>=0?'â–²':'â–¼';getEl(id+'-diff').innerHTML=`<span class="${cl} font-bold">${ar} ${Math.abs(pct)}%</span> <span class="text-stone-400 ml-1">vs ä¸ŠæœŸ ${formatMoney(pv)}</span>`;};
            sc('comp-inc',c.inc,p.inc); sc('comp-net',c.net,p.net);
            const ct=getEl('pie-chart'),ld=getEl('pie-legend'); 
            if(ct && ld) {
                ct.innerHTML=''; ld.innerHTML=''; let mp={}; c.txs.filter(t=>t.type==='out').forEach(t=>{mp[t.name]=(mp[t.name]||0)+t.amount;}); let cd=Object.keys(mp).map(k=>({name:k,value:mp[k]})).sort((a,b)=>b.value-a.value);
                if(cd.length===0)ct.innerHTML='<text x="50" y="50" text-anchor="middle" fill="#ccc" font-size="10" transform="rotate(90 50 50)">ç„¡è³‡æ–™</text>';
                else{ const tl=cd.reduce((s,i)=>s+i.value,0);let ac=0; cd.forEach((i,x)=>{const pc=i.value/tl,dg=pc*360,cl=CONFIG.colors[x%CONFIG.colors.length],x1=50+40*Math.cos(Math.PI*ac/180),y1=50+40*Math.sin(Math.PI*ac/180),x2=50+40*Math.cos(Math.PI*(ac+dg)/180),y2=50+40*Math.sin(Math.PI*(ac+dg)/180),d=cd.length===1?`M 50 50 m -40 0 a 40 40 0 1 0 80 0 a 40 40 0 1 0 -80 0`:`M 50 50 L ${x1} ${y1} A 40 40 0 ${dg>180?1:0} 1 ${x2} ${y2} Z`;const pt=document.createElementNS("http://www.w3.org/2000/svg","path");pt.setAttribute("d",d);pt.setAttribute("fill",cl);pt.setAttribute("stroke","#fff");ct.appendChild(pt);ac+=dg;const li=document.createElement('div');li.className="flex items-center gap-1.5";li.innerHTML=`<span class="w-2.5 h-2.5 rounded-full" style="background:${cl}"></span><span class="truncate text-coffee-800 flex-1">${i.name}</span><span class="text-stone-400">${Math.round(pc*100)}%</span>`;ld.appendChild(li);}); }
            }
            const sl=getEl('stock-list'); 
            if(sl) {
                sl.innerHTML=''; const it=Object.keys(c.stock);
                if(it.length===0 && getEl('stock-empty-msg')) getEl('stock-empty-msg').classList.remove('hidden');
                else { if(getEl('stock-empty-msg')) getEl('stock-empty-msg').classList.add('hidden'); it.forEach(n=>{const ci=c.stock[n],pi=p.stock[n]||{qty:0},dq=ci.qty-pi.qty,dc=dq>0?'text-red-400':(dq<0?'text-green-500':'text-stone-400'),di=dq>0?'â†‘':(dq<0?'â†“':'-');const dv=document.createElement('div');dv.className="bg-white p-3 rounded-xl shadow-sm border border-stone-100 flex justify-between items-center";dv.innerHTML=`<div class="font-bold text-coffee-800">${n}</div><div class="text-right"><div class="text-lg font-bold font-mono text-coffee-600">${ci.qty} <span class="text-xs text-stone-400">${ci.unit||''}</span></div><div class="text-xs ${dc} font-bold bg-stone-50 px-1.5 py-0.5 rounded inline-block">ä¸ŠæœŸ: ${pi.qty} (${di} ${Math.abs(dq)})</div></div>`;sl.appendChild(dv);}); }
            }

            // Attendance Report
            const al = getEl('attn-stats-list');
            if(al) {
                al.innerHTML = '';
                if(state.shifts.length === 0) getEl('attn-stats-empty').classList.remove('hidden');
                else {
                    getEl('attn-stats-empty').classList.add('hidden');
                    // Calculate rates per employee
                    state.employees.forEach(emp => {
                        const scheduled = state.shifts.filter(s => s.name === emp.name && s.date.startsWith(state.currentMonth)).length;
                        const attended = state.attendance.filter(a => a.name === emp.name && a.date.startsWith(state.currentMonth)).length;
                        if(scheduled > 0) {
                            const rate = Math.round((attended / scheduled) * 100);
                            const color = rate >= 90 ? 'text-green-600' : (rate >= 70 ? 'text-yellow-600' : 'text-red-500');
                            const div = document.createElement('div');
                            div.className = "flex justify-between items-center text-sm border-b border-stone-50 pb-2";
                            div.innerHTML = `<span class="font-bold text-coffee-800">${emp.name}</span><div class="flex gap-3"><span class="text-stone-400 text-xs">æ’ç­:${scheduled} / æ‰“å¡:${attended}</span><span class="${color} font-bold">${rate}%</span></div>`;
                            al.appendChild(div);
                        }
                    });
                }
            }
        }

        const Modal = { show: (opts) => { const el = getEl('app-modal'), t=getEl('modal-title'), m=getEl('modal-msg'), inp=getEl('modal-input-container'), i=getEl('modal-input'), c=getEl('modal-btn-cancel'), ok=getEl('modal-btn-confirm'), n=getEl('modal-notice-inputs'); 
            t.textContent=opts.title||'æç¤º'; m.textContent=opts.message||''; 
            
            // Logic for Notice Type
            if(opts.type === 'notice') {
                inp.classList.add('hidden');
                n.classList.remove('hidden');
            } else if(opts.type === 'prompt') {
                inp.classList.remove('hidden'); 
                n.classList.add('hidden');
                i.value=opts.defaultValue||''; 
                setTimeout(()=>i.focus(),100); 
            } else {
                inp.classList.add('hidden'); 
                n.classList.add('hidden');
            }
            
            c.classList.remove('hidden'); 
            const nOk=ok.cloneNode(true), nC=c.cloneNode(true); ok.parentNode.replaceChild(nOk, ok); c.parentNode.replaceChild(nC, c); 
            nC.onclick=()=>Modal.hide(); 
            
            if(opts.type==='alert'){ nC.classList.add('hidden'); nOk.onclick=()=>{Modal.hide();if(opts.onConfirm)opts.onConfirm();}; if(opts.autoClose) setTimeout(()=>Modal.hide(), opts.autoClose); } 
            else if(opts.type==='confirm' || opts.type==='notice'){ nOk.onclick=()=>{Modal.hide();if(opts.onConfirm)opts.onConfirm(true);}; } 
            else if(opts.type==='prompt'){ nOk.onclick=()=>{const v=i.value; if(!v)return; Modal.hide(); if(opts.onConfirm)opts.onConfirm(v);}; } 
            
            el.classList.remove('hidden'); 
        }, hide:()=>{getEl('app-modal').classList.add('hidden');}};
        window.Modal = Modal;
        
        getEl('month-select').value=state.currentMonth;
        getEl('month-select').addEventListener('change',(e)=>{state.currentMonth=e.target.value;render();if(state.view==='report')renderReport();if(state.view==='schedule')renderSchedule();});
        getEl('btn-save').addEventListener('click',window.addTransaction);
        getEl('btn-fixed-cost').addEventListener('click',window.safeAddFixedCost);
        getEl('btn-fixed-income').addEventListener('click',window.safeAddFixedIncome);
        window.updateItemSelect();
    </script>
</body>
</html>
